name: Multi-Client Deployment

on:
  workflow_dispatch:
    inputs:
      client_id:
        description: 'Client ID (e.g. "tms", "all", "all_android", "all_ios")'
        required: true
        default: 'all'
      deploy_platform:
        description: 'Platform to deploy (android, ios, all)'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - android
          - ios

jobs:
  # Job to determine which clients to build and which platform to target
  setup-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      platform: ${{ steps.set-matrix.outputs.platform }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 22

      - id: set-matrix
        env:
          EVENT_NAME: ${{ github.event_name }}
          INPUT_CLIENT_ID: ${{ inputs.client_id }}
          INPUT_PLATFORM: ${{ inputs.deploy_platform }}
        run: |
          # Use a specialized script to determine matrix and platform
          node -e '
            const fs = require("fs");

            // Default settings for Push event
            let targetClients = ["tms"];
            let targetPlatform = "all";

            const eventName = process.env.EVENT_NAME;
            const inputId = process.env.INPUT_CLIENT_ID;
            const inputPlatform = process.env.INPUT_PLATFORM;

            if (eventName === "workflow_dispatch") {
                // Read all available clients from config
                const clientsConfig = JSON.parse(fs.readFileSync("clients.config.json", "utf8"));
                const allClientIds = clientsConfig.map(c => c.id);

                targetPlatform = inputPlatform || "all";

                if (inputId === "all") {
                    targetClients = allClientIds;
                } else if (inputId === "all_android") {
                    targetClients = allClientIds;
                    targetPlatform = "android";
                } else if (inputId === "all_ios") {
                    targetClients = allClientIds;
                    targetPlatform = "ios";
                } else {
                    // Check if input is a comma-separated list or single ID
                    // For now assuming single ID or comma-separated valid IDs
                    // If user passed invalid ID, we might want to warn, but simple parsing here:
                    targetClients = inputId.split(",").map(s => s.trim()).filter(s => s.length > 0);
                }
            }

            console.log(`Calculated Clients: ${JSON.stringify(targetClients)}`);
            console.log(`Calculated Platform: ${targetPlatform}`);

            // Output to GitHub Actions
            const fsOut = require("fs");
            const matrixJson = JSON.stringify(targetClients);
            fsOut.appendFileSync(process.env.GITHUB_OUTPUT, `matrix=${matrixJson}\n`);
            fsOut.appendFileSync(process.env.GITHUB_OUTPUT, `platform=${targetPlatform}\n`);
          '

  deploy-ios:
    needs: setup-matrix
    # Run if platform is either "all" or "ios"
    if: ${{ needs.setup-matrix.outputs.platform == 'all' || needs.setup-matrix.outputs.platform == 'ios' }}
    runs-on: macos-latest
    strategy:
      matrix:
        client: ${{fromJson(needs.setup-matrix.outputs.matrix)}}
        platform: ["ios"]
      fail-fast: false

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Install Dependencies
        run: npm ci

      - name: Install Ionic, Cordova & cordova-res
        run: npm install -g @ionic/cli cordova cordova-res

      - name: Apply Client Configuration
        run: node scripts/apply_client_config.js --client-id ${{ matrix.client }} --platform ${{ matrix.platform }}

      - name: Patch iOS Source
        run: node scripts/patch_ios_source.js

      - name: Decrypt Android Keys (for reference/validation if needed, though this is iOS job)
        run: echo "Skipping Android keys for iOS job"

      # Setup Fastlane & Certs (Reusing logic from previous single-deploy workflow)
      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.0'
          bundler-cache: true

      - name: Setup Fastlane
        run: |
          gem install bundler:2.5.9
          bundle install

      - name: Deploy to TestFlight
        env:
          # Shared iOS Secrets
          APP_STORE_CONNECT_API_KEY_KEY_ID: ${{ secrets.IOS_ASC_KEY_ID }}
          APP_STORE_CONNECT_API_KEY_ISSUER_ID: ${{ secrets.IOS_ASC_ISSUER_ID }}
          APP_STORE_CONNECT_API_KEY_CONTENT_BASE64: ${{ secrets.IOS_ASC_KEY_CONTENT_BASE64 }}
          IOS_DEVELOPMENT_TEAM: ${{ secrets.IOS_DEVELOPMENT_TEAM }}
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          IOS_P12_BASE64: ${{ secrets.IOS_P12_BASE64 }}
          IOS_P12_PASSWORD: ${{ secrets.IOS_P12_PASSWORD }}
          # Client-specific Provisioning Profiles (add new clients here)
          TMS_IOS_PROVISIONING_PROFILE_BASE64: ${{ secrets.TMS_IOS_PROVISIONING_PROFILE_BASE64 }}
          FUTURE_IOS_PROVISIONING_PROFILE_BASE64: ${{ secrets.FUTURE_IOS_PROVISIONING_PROFILE_BASE64 }}
          IRTIQAA_IOS_PROVISIONING_PROFILE_BASE64: ${{ secrets.IRTIQAA_IOS_PROVISIONING_PROFILE_BASE64 }}
          LEADERS_IOS_PROVISIONING_PROFILE_BASE64: ${{ secrets.LEADERS_IOS_PROVISIONING_PROFILE_BASE64 }}
          ROYAL_IOS_PROVISIONING_PROFILE_BASE64: ${{ secrets.ROYAL_IOS_PROVISIONING_PROFILE_BASE64 }}
          PIONEERS_IOS_PROVISIONING_PROFILE_BASE64: ${{ secrets.PIONEERS_IOS_PROVISIONING_PROFILE_BASE64 }}
          # Current client ID
          CLIENT_ID: ${{ matrix.client }}
        run: |
          # Get the uppercase client ID for secret lookup
          CLIENT_UPPER=$(echo "$CLIENT_ID" | tr '[:lower:]' '[:upper:]')

          # Dynamically get the provisioning profile secret
          SECRET_VAR_NAME="${CLIENT_UPPER}_IOS_PROVISIONING_PROFILE_BASE64"
          PROFILE_BASE64="${!SECRET_VAR_NAME}"

          if [ -z "$PROFILE_BASE64" ]; then
            echo "Error: Provisioning profile secret not found for client: $CLIENT_ID (expected: $SECRET_VAR_NAME)"
            exit 1
          fi

          # Create temporary files for certs
          echo "$IOS_P12_BASE64" | base64 --decode > cert.p12
          echo "$PROFILE_BASE64" | base64 --decode > profile.mobileprovision

          # Import P12 to Keychain
          security create-keychain -p "" build.keychain
          security list-keychains -s build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "" build.keychain
          security set-keychain-settings -t 3600 -u build.keychain
          security import cert.p12 -k build.keychain -P "$IOS_P12_PASSWORD" -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple: -s -k "" build.keychain

          # Install Provisioning Profile
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/

          # Run Fastlane
          bundle exec fastlane ios deploy

  deploy-android:
    needs: setup-matrix
    # Run if platform is either "all" or "android"
    if: ${{ needs.setup-matrix.outputs.platform == 'all' || needs.setup-matrix.outputs.platform == 'android' }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        client: ${{fromJson(needs.setup-matrix.outputs.matrix)}}
        platform: ["android"]
      fail-fast: false

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
      - uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.0'
          bundler-cache: true

      - name: Update Bundler
        run: gem install bundler:2.5.9 # Installing a known stable version compatible with Ruby 3.0 and Fastlane

      - name: Install Dependencies
        run: npm ci

      - name: Install Ionic, Cordova & cordova-res
        run: npm install -g @ionic/cli cordova cordova-res

      - name: Apply Client Configuration
        run: node scripts/apply_client_config.js --client-id ${{ matrix.client }} --platform ${{ matrix.platform }}

      - name: Decode Android Keystore & Config
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
          ANDROID_PLAY_CONFIG_BASE64: ${{ secrets.ANDROID_PLAY_CONFIG_BASE64 }}
        run: |
          # Decode to current directory (root) to avoid confusion/permissions issues
          echo "$ANDROID_KEYSTORE_BASE64" | base64 --decode > ./syncology.keystore
          echo "$ANDROID_PLAY_CONFIG_BASE64" | base64 --decode > play-store-config.json

      - name: Create Build Config
        env:
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          # Create build.json in current directory with relative path to keystore
          cat <<EOF > ./build.json
          {
              "android": {
                  "release": {
                      "keystore": "syncology.keystore",
                      "storePassword": "$ANDROID_KEYSTORE_PASSWORD",
                      "alias": "$ANDROID_KEY_ALIAS",
                      "password": "$ANDROID_KEY_PASSWORD",
                      "packageType": "bundle"
                  }
              }
          }
          EOF

      - name: Build & Deploy
        env:
          SUPPLY_JSON_KEY: play-store-config.json
        run: |
          bundle install
          bundle exec fastlane android deploy
