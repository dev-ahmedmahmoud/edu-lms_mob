default_platform(:android)

platform :android do
  desc "Deploy to Google Play Internal Track"
  lane :deploy do
    # Build the AAB using the npm script we defined
    # We expect env vars for signing to be set in the CI environment
    sh("ionic cordova platform add android --no-interactive")
    # Build the AAB directly using Cordova commands
    # This avoids the npm script that relies on parent directory structure for build.json
    sh("ionic cordova build android --prod --release -- --packageType=bundle --buildConfig=build.json")

    # Upload to Play Store
    # json_key should be saved as a file from the secret in CI
    upload_to_play_store(
      track: 'internal',
      aab: 'platforms/android/app/build/outputs/bundle/release/app-release.aab',
      skip_upload_metadata: true,
      skip_upload_images: true,
      skip_upload_screenshots: true
    )
  end
end

platform :ios do
  desc "Deploy to TestFlight"
  lane :deploy do
    setup_ci

    # Get dynamic app name from environment
    app_name = ENV["CLIENT_APP_NAME"] || "Moodle"
    # Sanitize app name for Swift header (replace non-alphanumeric with underscore)
    swift_header_name = app_name.gsub(/[^a-zA-Z0-9]/, '_') + "-Swift.h"

    # Authenticate with App Store Connect
    api_key = app_store_connect_api_key(
      key_id: ENV["APP_STORE_CONNECT_API_KEY_KEY_ID"],
      issuer_id: ENV["APP_STORE_CONNECT_API_KEY_ISSUER_ID"],
      key_content: ENV["APP_STORE_CONNECT_API_KEY_CONTENT_BASE64"],
      is_key_content_base64: true,
      in_house: false
    )

    # Fix 'Moodle-Swift.h' import in EncryptionHandler.m in node_modules
    # This ensures it is copied correctly when platform is added
    # We patch it here because patching 'platforms/' after 'add' might be overwritten by 'prepare'
    puts "Searching for EncryptionHandler.m to patch..."
    nm_handler_path = "node_modules/@moodlehq/phonegap-plugin-push/src/ios/EncryptionHandler.m"
    if File.exist?(nm_handler_path)
      text = File.read(nm_handler_path)
      if text.include?("Moodle-Swift.h")
        puts "Found Moodle-Swift.h, replacing with #{swift_header_name}"
        new_contents = text.gsub("Moodle-Swift.h", swift_header_name)
        File.open(nm_handler_path, "w") {|file| file.puts new_contents }
        puts "Successfully patched EncryptionHandler.m in node_modules"
      else
        puts "Moodle-Swift.h string not found in file. Content usage might be different."
      end
    else
      puts "ERROR warning: Could not find EncryptionHandler.m at #{nm_handler_path}"
      # Fallback: maybe we are in 'fastlane' dir? Try ../node_modules
      nm_handler_path_fallback = "../node_modules/@moodlehq/phonegap-plugin-push/src/ios/EncryptionHandler.m"
      if File.exist?(nm_handler_path_fallback)
         puts "Found it at fallback path #{nm_handler_path_fallback}. Patching..."
         text = File.read(nm_handler_path_fallback)
         new_contents = text.gsub("Moodle-Swift.h", swift_header_name)
         File.open(nm_handler_path_fallback, "w") {|file| file.puts new_contents }
         puts "Successfully patched fallback path."
      else
         puts "ERROR: Really could not find EncryptionHandler.m"
      end
    end

    # Add iOS platform
    sh("ionic cordova platform add ios --no-interactive")

    # Install provisioning profile and certificate
    # We assume these are decoded from secrets into files by the GitHub Action
    # before running fastlane.

    profile_path = File.expand_path("~/Library/MobileDevice/Provisioning Profiles/profile.mobileprovision")
    # Extract the profile name using security and PlistBuddy
    profile_name = sh("/usr/libexec/PlistBuddy -c 'Print :Name' /dev/stdin <<< $(security cms -D -i '#{profile_path}')").strip

    # Disable automatic signing and set specific identity/profile
    update_code_signing_settings(
      path: "platforms/ios/#{app_name}.xcodeproj",
      use_automatic_signing: false,
      targets: [app_name],
      code_sign_identity: "iPhone Distribution",
      bundle_identifier: ENV["IOS_BUNDLE_ID"],
      team_id: ENV["IOS_DEVELOPMENT_TEAM"],
      profile_name: profile_name
    )

    # Update version/build number if needed (optional)
    # increment_build_number(xcodeproj: "platforms/ios/MoodleApp.xcodeproj")

    # Extract UUID for mapping
    profile_uuid = sh("/usr/libexec/PlistBuddy -c 'Print :UUID' /dev/stdin <<< $(security cms -D -i '#{profile_path}')").strip

    # Build the app using Ionic/Cordova
    # We use ionic directly because it handles the web build + cordova build
    # We pass the development team and other signing identities via flags.
    # Note: These flags need to come after '--' to be passed to the underlying xcodebuild/cordova command
    # Added --provisioningProfile to explicitly map the profile during export
    sh("ionic cordova build ios --no-interactive --prod --release --device -- --developmentTeam='#{ENV['IOS_DEVELOPMENT_TEAM']}' --codeSignIdentity='iPhone Distribution' --packageType='app-store-connect' --provisioningProfile='#{profile_uuid}'")

    # Upload to TestFlight with the API key
    upload_to_testflight(
      api_key: api_key,
      skip_waiting_for_build_processing: true,
      # The export path from logs is .../Release-iphoneos/..., not .../device/...
      # We just pass the directory to let fastlane find the .ipa, or point to the specific file if we know it.
      # Based on logs: Exported Tanta Modern School to: .../platforms/ios/build/Release-iphoneos
      ipa: "platforms/ios/build/Release-iphoneos/#{app_name}.ipa"
    )
  end
end
